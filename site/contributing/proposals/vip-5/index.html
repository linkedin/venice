<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Derived Data Platform for Planet-Scale Workloads"><meta name=author content="Venice Team"><link href=https://venicedb.org/contributing/proposals/vip-5/ rel=canonical><link href=../vip-4/ rel=prev><link href=../vip-6/ rel=next><link rel=icon href=../../../assets/style/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>VIP-5 - Venice</title><link rel=stylesheet href=../../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/style/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=white> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#vip-5-facet-counting class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=Venice class="md-header__button md-logo" aria-label=Venice data-md-component=logo> <img src=../../../assets/style/venice_full_lion_logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Venice </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> VIP-5 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=white aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=black aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/linkedin/venice title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> linkedin/venice </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../../user-guide/ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../../operations/ class=md-tabs__link> Operations </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> Contributing </a> </li> <li class=md-tabs__item> <a href=../../../resources/learn-more/ class=md-tabs__link> Resources </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=Venice class="md-nav__button md-logo" aria-label=Venice data-md-component=logo> <img src=../../../assets/style/venice_full_lion_logo.svg alt=logo> </a> Venice </label> <div class=md-nav__source> <a href=https://github.com/linkedin/venice title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> linkedin/venice </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <div class="md-nav__link md-nav__container"> <a href=../../../getting-started/ class="md-nav__link "> <span class=md-ellipsis> Getting Started </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../getting-started/quickstart-single-dc/ class=md-nav__link> <span class=md-ellipsis> Single Datacenter </span> </a> </li> <li class=md-nav__item> <a href=../../../getting-started/quickstart-multi-dc/ class=md-nav__link> <span class=md-ellipsis> Multi Datacenter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/ class="md-nav__link "> <span class=md-ellipsis> User Guide </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/concepts/overview/ class=md-nav__link> <span class=md-ellipsis> Venice Concepts </span> </a> </li> <li class=md-nav__item> <a href=../../../user-guide/concepts/ttl/ class=md-nav__link> <span class=md-ellipsis> Time to Live (TTL) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/write-apis/ class="md-nav__link "> <span class=md-ellipsis> Write APIs </span> </a> <label class="md-nav__link " for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Write APIs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/write-apis/batch-push/ class=md-nav__link> <span class=md-ellipsis> Batch Push </span> </a> </li> <li class=md-nav__item> <a href=../../../user-guide/write-apis/stream-processor/ class=md-nav__link> <span class=md-ellipsis> Stream Processor </span> </a> </li> <li class=md-nav__item> <a href=../../../user-guide/write-apis/online-producer/ class=md-nav__link> <span class=md-ellipsis> Online Producer </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/read-apis/ class="md-nav__link "> <span class=md-ellipsis> Read APIs </span> </a> <label class="md-nav__link " for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Read APIs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/read-apis/da-vinci-client/ class=md-nav__link> <span class=md-ellipsis> Da Vinci Client </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/design-patterns/ class="md-nav__link "> <span class=md-ellipsis> Design Patterns </span> </a> <label class="md-nav__link " for=__nav_3_5 id=__nav_3_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Design Patterns </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/design-patterns/merging-batch-and-rt/ class=md-nav__link> <span class=md-ellipsis> Merging Batch & RT </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../../operations/ class="md-nav__link "> <span class=md-ellipsis> Operations </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Operations </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Data Management </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Data Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/data-management/repush/ class=md-nav__link> <span class=md-ellipsis> Repush </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/data-management/system-stores/ class=md-nav__link> <span class=md-ellipsis> System Stores </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> Advanced </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/advanced/p2p-bootstrapping/ class=md-nav__link> <span class=md-ellipsis> P2P Bootstrapping </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/advanced/data-integrity/ class=md-nav__link> <span class=md-ellipsis> Data Integrity </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> Contributing </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Contributing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../code-of-conduct/ class=md-nav__link> <span class=md-ellipsis> Code of Conduct </span> </a> </li> <li class=md-nav__item> <a href=../../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing Guide </span> </a> </li> <li class=md-nav__item> <a href=../../security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5 id=__nav_5_5_label tabindex> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../development/workspace-setup/ class=md-nav__link> <span class=md-ellipsis> Workspace Setup </span> </a> </li> <li class=md-nav__item> <a href=../../development/dev-workflow/ class=md-nav__link> <span class=md-ellipsis> Dev Workflow </span> </a> </li> <li class=md-nav__item> <a href=../../development/testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../../development/style-guide/ class=md-nav__link> <span class=md-ellipsis> Style Guide </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_6> <label class=md-nav__link for=__nav_5_6 id=__nav_5_6_label tabindex> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/navigation/ class=md-nav__link> <span class=md-ellipsis> Project Navigation </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/write-path/ class=md-nav__link> <span class=md-ellipsis> Write Path </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/java-internals/ class=md-nav__link> <span class=md-ellipsis> Java Internals </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/router-api/ class=md-nav__link> <span class=md-ellipsis> Router API </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_7> <label class=md-nav__link for=__nav_5_7 id=__nav_5_7_label tabindex> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_7_label aria-expanded=false> <label class=md-nav__title for=__nav_5_7> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../documentation/writing-docs/ class=md-nav__link> <span class=md-ellipsis> Writing Docs </span> </a> </li> <li class=md-nav__item> <a href=../../documentation/design-docs/ class=md-nav__link> <span class=md-ellipsis> Design Docs </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> Proposals </span> </a> <label class="md-nav__link " for=__nav_5_8 id=__nav_5_8_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=true> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> Proposals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../vip-template/ class=md-nav__link> <span class=md-ellipsis> VIP Template </span> </a> </li> <li class=md-nav__item> <a href=../vip-1/ class=md-nav__link> <span class=md-ellipsis> VIP-1 </span> </a> </li> <li class=md-nav__item> <a href=../vip-2/ class=md-nav__link> <span class=md-ellipsis> VIP-2 </span> </a> </li> <li class=md-nav__item> <a href=../vip-3/ class=md-nav__link> <span class=md-ellipsis> VIP-3 </span> </a> </li> <li class=md-nav__item> <a href=../vip-4/ class=md-nav__link> <span class=md-ellipsis> VIP-4 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> VIP-5 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> VIP-5 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#problem-statement class=md-nav__link> <span class=md-ellipsis> Problem Statement </span> </a> <nav class=md-nav aria-label="Problem Statement"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#facet-counting-use-cases class=md-nav__link> <span class=md-ellipsis> Facet Counting Use Cases </span> </a> </li> <li class=md-nav__item> <a href=#where-to-perform-the-counting class=md-nav__link> <span class=md-ellipsis> Where to Perform the Counting? </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scope class=md-nav__link> <span class=md-ellipsis> Scope </span> </a> </li> <li class=md-nav__item> <a href=#project-justification class=md-nav__link> <span class=md-ellipsis> Project Justification </span> </a> </li> <li class=md-nav__item> <a href=#functional-specification class=md-nav__link> <span class=md-ellipsis> Functional Specification </span> </a> </li> <li class=md-nav__item> <a href=#proposed-design class=md-nav__link> <span class=md-ellipsis> Proposed Design </span> </a> </li> <li class=md-nav__item> <a href=#development-milestones class=md-nav__link> <span class=md-ellipsis> Development Milestones </span> </a> <nav class=md-nav aria-label="Development Milestones"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#future-work class=md-nav__link> <span class=md-ellipsis> Future Work </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#test-plan class=md-nav__link> <span class=md-ellipsis> Test Plan </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> <li class=md-nav__item> <a href=#appendix class=md-nav__link> <span class=md-ellipsis> Appendix </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../vip-6/ class=md-nav__link> <span class=md-ellipsis> VIP-6 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../resources/learn-more/ class=md-nav__link> <span class=md-ellipsis> Learn More </span> </a> </li> <li class=md-nav__item> <a href=../../../resources/api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> </a> </li> <li class=md-nav__item> <a href=../../../resources/community/ class=md-nav__link> <span class=md-ellipsis> Community </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#problem-statement class=md-nav__link> <span class=md-ellipsis> Problem Statement </span> </a> <nav class=md-nav aria-label="Problem Statement"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#facet-counting-use-cases class=md-nav__link> <span class=md-ellipsis> Facet Counting Use Cases </span> </a> </li> <li class=md-nav__item> <a href=#where-to-perform-the-counting class=md-nav__link> <span class=md-ellipsis> Where to Perform the Counting? </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#scope class=md-nav__link> <span class=md-ellipsis> Scope </span> </a> </li> <li class=md-nav__item> <a href=#project-justification class=md-nav__link> <span class=md-ellipsis> Project Justification </span> </a> </li> <li class=md-nav__item> <a href=#functional-specification class=md-nav__link> <span class=md-ellipsis> Functional Specification </span> </a> </li> <li class=md-nav__item> <a href=#proposed-design class=md-nav__link> <span class=md-ellipsis> Proposed Design </span> </a> </li> <li class=md-nav__item> <a href=#development-milestones class=md-nav__link> <span class=md-ellipsis> Development Milestones </span> </a> <nav class=md-nav aria-label="Development Milestones"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#future-work class=md-nav__link> <span class=md-ellipsis> Future Work </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#test-plan class=md-nav__link> <span class=md-ellipsis> Test Plan </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> <li class=md-nav__item> <a href=#appendix class=md-nav__link> <span class=md-ellipsis> Appendix </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../../.. class=md-path__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-path__item> <a href=../../ class=md-path__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-path__item> <a href=../ class=md-path__link> <span class=md-ellipsis> Proposals </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <a href=https://github.com/linkedin/venice/edit/main/docs/contributing/proposals/vip-5.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <h1 id=vip-5-facet-counting>VIP-5: Facet Counting<a class=headerlink href=#vip-5-facet-counting title="Permanent link">&para;</a></h1> <ul> <li><strong>Status</strong>: <em>Accepted</em></li> <li><strong>Author(s)</strong>: <em>Felix GV</em></li> <li><strong>Pull Request</strong>: <a href=https://github.com/linkedin/venice/pull/1612>PR 1612</a></li> <li><strong>Release</strong>: <em>N/A</em></li> </ul> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>Facet Counting is a type of aggregation query popular in the search domain. It provides information about the cardinality of values for the fields of documents of interest.</p> <p>Given that search is one of the types of derived data workloads in which Venice already participates (i.e., the Da Vinci Client can serve as a search solution's forward index component), there is demand from Venice users to increase the scope of capabilities such that Facet Counting can also be performed natively by Venice.</p> <p>This document introduces the domain, and suggests a roadmap for implementing this capability in various phases, including on the client-side and server-side.</p> <h2 id=problem-statement>Problem Statement<a class=headerlink href=#problem-statement title="Permanent link">&para;</a></h2> <p>This section dives deeper in defining what Facet Counting is, and how to integrate it into Venice.</p> <p>Before diving into specifics, it may be useful to provide an analogy in order to make a general observation: <em>the proposal in this VIP has similarities and differences compared to Read Compute</em>. Read Compute, as it exists today, is a record-wise (or we could say: row-wise) operation, meaning that for a given input record there is exactly one output record. This type of workload is very natural to push down into the server-side, in such way that the work is split across many servers and the client can retrieve the various output records individually. The use cases presented here also have a portion of work which is executable on a per-record basis, and therefore has the potential of being pushed down to the server-side, however, given that they are "aggregation queries", there is also a final processing step which must be performed in some central location (e.g., in the client). The work can therefore only be partially pushed down.</p> <h3 id=facet-counting-use-cases>Facet Counting Use Cases<a class=headerlink href=#facet-counting-use-cases title="Permanent link">&para;</a></h3> <p>Let's define what Facet Counting is, with a series of examples from simple to more complex, using SQL to explain it (although SQL is just a convenient way to express query semantics, but is not part of this proposal).</p> <p>These are functioning SQL queries that have been run on a DuckDB database populated by Venice's own Push Job Details <a href=../../../operations/data-management/system-stores/ >system store</a>. This system store's Avro schema can be seen here: <a href=https://github.com/linkedin/venice/blob/main/internal/venice-common/src/main/resources/avro/PushJobStatusRecordKey/v1/PushJobStatusRecordKey.avsc>key</a>, <a href=https://github.com/linkedin/venice/blob/main/internal/venice-common/src/main/resources/avro/PushJobDetails/v4/PushJobDetails.avsc>value</a>. The SQL schema for the table is also included below, though only a subset of these columns are used in the examples:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>column_name</span><span class=p>,</span><span class=w> </span><span class=n>column_type</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=k>DESCRIBE</span><span class=w> </span><span class=n>current_version</span><span class=p>);</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=err>┌───────────────────────────────────────┬─────────────┐</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=err>│</span><span class=w>              </span><span class=k>column_name</span><span class=w>              </span><span class=err>│</span><span class=w> </span><span class=n>column_type</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=err>│</span><span class=w>                </span><span class=nb>varchar</span><span class=w>                </span><span class=err>│</span><span class=w>   </span><span class=nb>varchar</span><span class=w>   </span><span class=err>│</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=err>├───────────────────────────────────────┼─────────────┤</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=err>│</span><span class=w> </span><span class=n>storeName</span><span class=w>                             </span><span class=err>│</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=err>│</span><span class=w> </span><span class=n>versionNumber</span><span class=w>                         </span><span class=err>│</span><span class=w> </span><span class=nb>INTEGER</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=err>│</span><span class=w> </span><span class=n>clusterName</span><span class=w>                           </span><span class=err>│</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=err>│</span><span class=w> </span><span class=n>reportTimestamp</span><span class=w>                       </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=err>│</span><span class=w> </span><span class=n>pushId</span><span class=w>                                </span><span class=err>│</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=err>│</span><span class=w> </span><span class=n>partitionCount</span><span class=w>                        </span><span class=err>│</span><span class=w> </span><span class=nb>INTEGER</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=err>│</span><span class=w> </span><span class=n>valueCompressionStrategy</span><span class=w>              </span><span class=err>│</span><span class=w> </span><span class=nb>INTEGER</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=err>│</span><span class=w> </span><span class=n>chunkingEnabled</span><span class=w>                       </span><span class=err>│</span><span class=w> </span><span class=nb>BOOLEAN</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=err>│</span><span class=w> </span><span class=n>jobDurationInMs</span><span class=w>                       </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=err>│</span><span class=w> </span><span class=n>totalNumberOfRecords</span><span class=w>                  </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=err>│</span><span class=w> </span><span class=n>totalKeyBytes</span><span class=w>                         </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=err>│</span><span class=w> </span><span class=n>totalRawValueBytes</span><span class=w>                    </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=err>│</span><span class=w> </span><span class=n>totalCompressedValueBytes</span><span class=w>             </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=err>│</span><span class=w> </span><span class=n>totalGzipCompressedValueBytes</span><span class=w>         </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=err>│</span><span class=w> </span><span class=n>totalZstdWithDictCompressedValueBytes</span><span class=w> </span><span class=err>│</span><span class=w> </span><span class=nb>BIGINT</span><span class=w>      </span><span class=err>│</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=err>│</span><span class=w> </span><span class=n>pushJobLatestCheckpoint</span><span class=w>               </span><span class=err>│</span><span class=w> </span><span class=nb>INTEGER</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=err>│</span><span class=w> </span><span class=n>failureDetails</span><span class=w>                        </span><span class=err>│</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=err>│</span><span class=w> </span><span class=n>sendLivenessHeartbeatFailureDetails</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w>     </span><span class=err>│</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=err>├───────────────────────────────────────┴─────────────┤</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=err>│</span><span class=w> </span><span class=mi>18</span><span class=w> </span><span class=k>rows</span><span class=w>                                   </span><span class=mi>2</span><span class=w> </span><span class=n>columns</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=err>└─────────────────────────────────────────────────────┘</span>
</code></pre></div> <h4 id=facet-counting-by-values-of-a-single-column>Facet Counting by Values of a Single Column<a class=headerlink href=#facet-counting-by-values-of-a-single-column title="Permanent link">&para;</a></h4> <p>The simplest example of Facet Counting would be to count how many times each distinct value appears in a given column, and we would typically want to limit the amount of results returned, as there could be quite a few:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>SELECT</span><span class=w>   </span><span class=n>storeName</span><span class=p>,</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>         </span><span class=k>COUNT</span><span class=p>(</span><span class=n>storeName</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>cnt</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>storeName</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=k>DESC</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=k>LIMIT</span><span class=w>    </span><span class=mi>5</span><span class=p>;</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=err>┌─────────────────────────────┬───────┐</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=err>│</span><span class=w>          </span><span class=n>storeName</span><span class=w>          </span><span class=err>│</span><span class=w>  </span><span class=n>cnt</span><span class=w>  </span><span class=err>│</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=err>│</span><span class=w>           </span><span class=nb>varchar</span><span class=w>           </span><span class=err>│</span><span class=w> </span><span class=n>int64</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=err>├─────────────────────────────┼───────┤</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>0</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2539</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>13</span><span class=w> </span><span class=err>│</span><span class=w>  </span><span class=mi>2340</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>8</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2337</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>7</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2335</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>3</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2334</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=err>└─────────────────────────────┴───────┘</span>
</code></pre></div> <h4 id=facet-counting-by-buckets-within-a-column>Facet Counting by Buckets Within a Column<a class=headerlink href=#facet-counting-by-buckets-within-a-column title="Permanent link">&para;</a></h4> <p>Another example would be to group not by values, but by buckets. An example of this would be to have buckets for "last 24h", "last week", "last 30 days".</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>SET</span><span class=w> </span><span class=k>VARIABLE</span><span class=w> </span><span class=n>most_recent_job_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>reportTimestamp</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>current_version</span><span class=p>);</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>SET</span><span class=w> </span><span class=k>VARIABLE</span><span class=w> </span><span class=n>ms_per_day</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=mi>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=p>);</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=k>SET</span><span class=w> </span><span class=k>VARIABLE</span><span class=w> </span><span class=n>ms_per_week</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_day&#39;</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>7</span><span class=p>);</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=k>SET</span><span class=w> </span><span class=k>VARIABLE</span><span class=w> </span><span class=n>ms_per_30_days</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>CAST</span><span class=p>(</span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_day&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>BIGINT</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>30</span><span class=p>);</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;last_24h&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>reportTimestamp</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span><span class=k>WHERE</span><span class=w>    </span><span class=n>reportTimestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;most_recent_job_time&#39;</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_day&#39;</span><span class=p>))</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=k>UNION</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;last_week&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>reportTimestamp</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>    </span><span class=k>WHERE</span><span class=w>    </span><span class=n>reportTimestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;most_recent_job_time&#39;</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_week&#39;</span><span class=p>))</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=k>UNION</span>
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;last_30_days&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span>
<a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>reportTimestamp</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
<a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span>
<a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=w>    </span><span class=k>WHERE</span><span class=w>    </span><span class=n>reportTimestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;most_recent_job_time&#39;</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_30_days&#39;</span><span class=p>))</span>
<a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>cnt</span><span class=p>;</span>
<a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>
<a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=err>┌─────────────────┬───────┐</span>
<a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a><span class=err>│</span><span class=w> </span><span class=n>value_or_bucket</span><span class=w> </span><span class=err>│</span><span class=w>  </span><span class=n>cnt</span><span class=w>  </span><span class=err>│</span>
<a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=err>│</span><span class=w>     </span><span class=nb>varchar</span><span class=w>     </span><span class=err>│</span><span class=w> </span><span class=n>int64</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=err>├─────────────────┼───────┤</span>
<a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a><span class=err>│</span><span class=w> </span><span class=n>last_24h</span><span class=w>        </span><span class=err>│</span><span class=w>  </span><span class=mi>2150</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a><span class=err>│</span><span class=w> </span><span class=n>last_week</span><span class=w>       </span><span class=err>│</span><span class=w> </span><span class=mi>14811</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a><span class=err>│</span><span class=w> </span><span class=n>last_30_days</span><span class=w>    </span><span class=err>│</span><span class=w> </span><span class=mi>61991</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a><span class=err>└─────────────────┴───────┘</span>
</code></pre></div> <h4 id=facet-counting-on-multiple-columns>Facet Counting on Multiple Columns<a class=headerlink href=#facet-counting-on-multiple-columns title="Permanent link">&para;</a></h4> <p>Finally, a common example of Facet Counting would be to perform the same as above, but for multiple columns, all at once. In real scenarios, there could be hundreds of columns included, but to keep things simple we will do only two columns counted by values and one column counted by bucket:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;clusterName&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>col</span><span class=p>,</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>             </span><span class=n>clusterName</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>clusterName</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>cnt</span><span class=w> </span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span><span class=w> </span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>clusterName</span><span class=w> </span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>cnt</span><span class=w> </span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>    </span><span class=k>DESC</span><span class=w>     </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>5</span><span class=p>)</span><span class=w> </span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=k>UNION</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;storeName&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>col</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>             </span><span class=n>storeName</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span><span class=w> </span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>storeName</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>cnt</span><span class=w> </span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span><span class=w> </span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>storeName</span><span class=w> </span>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>    </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>cnt</span><span class=w> </span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>    </span><span class=k>DESC</span><span class=w>     </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=k>UNION</span>
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;reportTimestamp&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>col</span><span class=p>,</span>
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>             </span><span class=s1>&#39;last_24h&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span>
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>reportTimestamp</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span>
<a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>    </span><span class=k>WHERE</span><span class=w>    </span><span class=n>reportTimestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;most_recent_job_time&#39;</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_day&#39;</span><span class=p>))</span>
<a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=k>UNION</span>
<a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;reportTimestamp&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>col</span><span class=p>,</span>
<a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a><span class=w>             </span><span class=s1>&#39;last_week&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span>
<a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>reportTimestamp</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
<a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span>
<a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=w>    </span><span class=k>WHERE</span><span class=w>    </span><span class=n>reportTimestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;most_recent_job_time&#39;</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_week&#39;</span><span class=p>))</span>
<a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a><span class=k>UNION</span>
<a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a><span class=w>    </span><span class=k>SELECT</span><span class=w>   </span><span class=s1>&#39;reportTimestamp&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>col</span><span class=p>,</span>
<a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a><span class=w>             </span><span class=s1>&#39;last_30_days&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>value_or_bucket</span><span class=p>,</span>
<a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a><span class=w>             </span><span class=k>COUNT</span><span class=p>(</span><span class=n>reportTimestamp</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span>
<a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a><span class=w>    </span><span class=k>FROM</span><span class=w>     </span><span class=n>current_version</span>
<a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a><span class=w>    </span><span class=k>WHERE</span><span class=w>    </span><span class=n>reportTimestamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;most_recent_job_time&#39;</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>GETVARIABLE</span><span class=p>(</span><span class=s1>&#39;ms_per_30_days&#39;</span><span class=p>))</span>
<a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>col</span><span class=p>,</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
<a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a><span class=err>┌─────────────────┬─────────────────────────────┬───────┐</span>
<a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a><span class=err>│</span><span class=w>       </span><span class=n>col</span><span class=w>       </span><span class=err>│</span><span class=w>       </span><span class=n>value_or_bucket</span><span class=w>       </span><span class=err>│</span><span class=w>  </span><span class=n>cnt</span><span class=w>  </span><span class=err>│</span>
<a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a><span class=err>│</span><span class=w>     </span><span class=nb>varchar</span><span class=w>     </span><span class=err>│</span><span class=w>           </span><span class=nb>varchar</span><span class=w>           </span><span class=err>│</span><span class=w> </span><span class=n>int64</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a><span class=err>├─────────────────┼─────────────────────────────┼───────┤</span>
<a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a><span class=err>│</span><span class=w> </span><span class=n>clusterName</span><span class=w>     </span><span class=err>│</span><span class=w> </span><span class=n>venice</span><span class=o>-</span><span class=mi>1</span><span class=w>                    </span><span class=err>│</span><span class=w> </span><span class=mi>51060</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a><span class=err>│</span><span class=w> </span><span class=n>clusterName</span><span class=w>     </span><span class=err>│</span><span class=w> </span><span class=n>venice</span><span class=o>-</span><span class=mi>3</span><span class=w>                    </span><span class=err>│</span><span class=w> </span><span class=mi>33422</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a><span class=err>│</span><span class=w> </span><span class=n>clusterName</span><span class=w>     </span><span class=err>│</span><span class=w> </span><span class=n>venice</span><span class=o>-</span><span class=mi>5</span><span class=w>                    </span><span class=err>│</span><span class=w> </span><span class=mi>27961</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a><span class=err>│</span><span class=w> </span><span class=n>clusterName</span><span class=w>     </span><span class=err>│</span><span class=w> </span><span class=n>venice</span><span class=o>-</span><span class=mi>0</span><span class=w>                    </span><span class=err>│</span><span class=w> </span><span class=mi>18471</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a><span class=err>│</span><span class=w> </span><span class=n>clusterName</span><span class=w>     </span><span class=err>│</span><span class=w> </span><span class=n>venice</span><span class=o>-</span><span class=mi>4</span><span class=w>                    </span><span class=err>│</span><span class=w> </span><span class=mi>18350</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a><span class=err>│</span><span class=w> </span><span class=n>reportTimestamp</span><span class=w> </span><span class=err>│</span><span class=w> </span><span class=n>last_30_days</span><span class=w>                </span><span class=err>│</span><span class=w> </span><span class=mi>61991</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a><span class=err>│</span><span class=w> </span><span class=n>reportTimestamp</span><span class=w> </span><span class=err>│</span><span class=w> </span><span class=n>last_week</span><span class=w>                   </span><span class=err>│</span><span class=w> </span><span class=mi>14811</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a><span class=err>│</span><span class=w> </span><span class=n>reportTimestamp</span><span class=w> </span><span class=err>│</span><span class=w> </span><span class=n>last_24h</span><span class=w>                    </span><span class=err>│</span><span class=w>  </span><span class=mi>2150</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a><span class=err>│</span><span class=w> </span><span class=n>storeName</span><span class=w>       </span><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>0</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2539</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-53 name=__codelineno-3-53 href=#__codelineno-3-53></a><span class=err>│</span><span class=w> </span><span class=n>storeName</span><span class=w>       </span><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>13</span><span class=w> </span><span class=err>│</span><span class=w>  </span><span class=mi>2340</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-54 name=__codelineno-3-54 href=#__codelineno-3-54></a><span class=err>│</span><span class=w> </span><span class=n>storeName</span><span class=w>       </span><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>8</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2337</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-55 name=__codelineno-3-55 href=#__codelineno-3-55></a><span class=err>│</span><span class=w> </span><span class=n>storeName</span><span class=w>       </span><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>7</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2335</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-56 name=__codelineno-3-56 href=#__codelineno-3-56></a><span class=err>│</span><span class=w> </span><span class=n>storeName</span><span class=w>       </span><span class=err>│</span><span class=w> </span><span class=n>HB_VPJtarget_prod</span><span class=o>-</span><span class=n>venice</span><span class=o>-</span><span class=mi>3</span><span class=w>  </span><span class=err>│</span><span class=w>  </span><span class=mi>2334</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-57 name=__codelineno-3-57 href=#__codelineno-3-57></a><span class=err>├─────────────────┴─────────────────────────────┴───────┤</span>
<a id=__codelineno-3-58 name=__codelineno-3-58 href=#__codelineno-3-58></a><span class=err>│</span><span class=w> </span><span class=mi>13</span><span class=w> </span><span class=k>rows</span><span class=w>                                     </span><span class=mi>3</span><span class=w> </span><span class=n>columns</span><span class=w> </span><span class=err>│</span>
<a id=__codelineno-3-59 name=__codelineno-3-59 href=#__codelineno-3-59></a><span class=err>└───────────────────────────────────────────────────────┘</span>
</code></pre></div> <h4 id=filtering>Filtering<a class=headerlink href=#filtering title="Permanent link">&para;</a></h4> <p>The above examples all demonstrate Facet Counting being performed on a full table. And while that is feasible, it can be a costly proposition. In practice, a more common scenario is to perform Facet Counting on a subset of rows of the dataset. In the case of this proposal, the goal is to provide the ability to perform Facet Counting on some pre-defined keys within the Venice dataset.</p> <h3 id=where-to-perform-the-counting>Where to Perform the Counting?<a class=headerlink href=#where-to-perform-the-counting title="Permanent link">&para;</a></h3> <p>There are a variety of locations where the counting could be performed: client, router, server. Ultimately, it is probably ideal to have the ability to perform it in all three locations, and to decide by configuration what mode the system will operate in, so that we have the most operational flexibility. That, however, does not mean that we need to implement all of these in order to start getting value from the project (see Development Milestones).</p> <h4 id=client-side-computation>Client-side Computation<a class=headerlink href=#client-side-computation title="Permanent link">&para;</a></h4> <p>There is already support for performing Read Compute on the client-side, which is useful as a fallback in cases where server-side Read Compute is disabled for the queried store. Similarly, the ability to perform server-side Facet Counting should be enabled via a store config, and the client should be capable of gracefully degrading to client-side compute if the server-side is disabled. This is important so that users can make use of the API no matter what the server-side settings are, and configs then become a lever for shifting work across components, rather than a functional blocker.</p> <h4 id=server-side-computation>Server-side Computation<a class=headerlink href=#server-side-computation title="Permanent link">&para;</a></h4> <p>The appeal of supporting server-side computations for Facet Counting is the same as for Read Compute:</p> <ol> <li>The response sizes should be much smaller, thus saving on network bandwidth and improving the overall end-to-end performance.</li> <li>Moreover, the work can be partitioned across many servers, each of which would need to do just a fraction of the total.</li> </ol> <p>The difference with currently supported Read Compute queries is that, given that Facet Counting is an aggregation query, there still needs to be some amount of work performed in the component which receives the subset of results from each server. In the case of the Fast Client, this final step must be performed on the FC itself. In the case of the Thin Client, it could be performed either on the TC or on the Router.</p> <h4 id=router-side-computation>Router-side Computation<a class=headerlink href=#router-side-computation title="Permanent link">&para;</a></h4> <p>As mentioned above, for Thin Clients performing Facet Counting queries on a store where server-side computation is enabled, the final step of the query processing could be done either on the client-side or router-side. From a functional standpoint, either way works, but from an efficiency standpoint, it may be better to do it on the router-side to further reduce network bandwidth (between router and client). That being said, given that latency-sensitive applications ought to onboard to the Fast Client anyway, there may be diminishing returns in expending effort to support router-side computation. Therefore, this milestone can be scheduled last, and it may be acceptable to not implement it at all.</p> <h2 id=scope>Scope<a class=headerlink href=#scope title="Permanent link">&para;</a></h2> <p>The following is in-scope:</p> <ol> <li>Count by value and count by bucket, both of which would apply to specified keys only.</li> <li>The ability to perform counting on multiple columns as part of the same query, including the ability to specify the same column for the sake of both count by value and count by bucket.</li> <li>Client-side (TC, FC, DVC) and server-side computation.</li> </ol> <p>The following is out of scope:</p> <ol> <li>Full table scans.</li> <li>Router-side computation.</li> <li>Perform both Read Compute and Facet Counting on the same keys as part of the same query.</li> </ol> <h2 id=project-justification>Project Justification<a class=headerlink href=#project-justification title="Permanent link">&para;</a></h2> <p>The goal of this project is to make Venice more amenable to leverage in a variety of derived data use cases. This can help users minimize the complexity of juggling multiple independent systems, leading to productivity and operability improvements for them.</p> <p>While it is already possible for users to manually implement Facet Counting on data retrieved via Batch Get (which would be equivalent to the client-side support described above, from a performance standpoint), this approach does not scale well for larger workloads. Having the ability to code against a Venice-provided API and let the infrastructure decide if/when to shift the workload to the server-side provides better cost and scalability options.</p> <h2 id=functional-specification>Functional Specification<a class=headerlink href=#functional-specification title="Permanent link">&para;</a></h2> <p>The Facet Counting API would be a DSL similar to, but distinct from, the Read Compute API. Queries could be specified using the following builder pattern:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>ComputeAggregationRequestBuilder</span><span class=o>&lt;</span><span class=n>K</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ExecutableRequestBuilder</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=w> </span><span class=n>ComputeAggregationResponse</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>  </span><span class=cm>/**</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=cm>   * Aggregation query where the content of specified fields are going to be grouped by their value, then the occurrence</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=cm>   * of each distinct value counted, after which the top K highest counts along with their associated values are going</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=cm>   * to be returned.</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=cm>   *</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=cm>   * @param topK The max number of distinct values for which to return a count.</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=cm>   * @param fieldNames The names of fields for which to perform the facet counting.</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=cm>   * @return The same builder instance, to chain additional operations onto.</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=cm>   */</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>  </span><span class=n>ComputeAggregationRequestBuilder</span><span class=o>&lt;</span><span class=n>K</span><span class=o>&gt;</span><span class=w> </span><span class=nf>countGroupByValue</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>topK</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>...</span><span class=w> </span><span class=n>fieldNames</span><span class=p>);</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>  </span><span class=cm>/**</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=cm>   * Aggregation query where the content of specified fields are going to be grouped by buckets, with each bucket being</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=cm>   * defined by some {@link Predicate}, and each matching occurrence incrementing a count for its associated bucket,</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=cm>   * after which the bucket names to counts are going to be returned.</span>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=cm>   *</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=cm>   * @param bucketNameToPredicate A map of predicate name -&gt; {@link Predicate} to define the buckets to group values by.</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=cm>   * @param fieldNames The names of fields for which to perform the facet counting.</span>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=cm>   * @return The same builder instance, to chain additional operations onto.</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=cm>   * @param &lt;T&gt; The type of the fields to apply the bucket predicates to.</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=cm>   */</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=w>  </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>ComputeAggregationRequestBuilder</span><span class=o>&lt;</span><span class=n>K</span><span class=o>&gt;</span><span class=w> </span><span class=nf>countGroupByBucket</span><span class=p>(</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>          </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Predicate</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>bucketNameToPredicate</span><span class=p>,</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>          </span><span class=n>String</span><span class=p>...</span><span class=w> </span><span class=n>fieldNames</span><span class=p>);</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=p>}</span>
</code></pre></div> <p>Responses could be accessed using the following container:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>ComputeAggregationResponse</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>  </span><span class=cm>/**</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=cm>   * @param fieldName for which to get the value -&gt; count map</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=cm>   * @return the value counts as defined by {@link ComputeAggregationRequestBuilder#countGroupByValue(int, String...)}</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=cm>   */</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>  </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getValueToCount</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>fieldName</span><span class=p>);</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>  </span><span class=cm>/**</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=cm>   * @param fieldName for which to get the bucket -&gt; count map</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=cm>   * @return the bucket counts as defined by {@link ComputeAggregationRequestBuilder#countGroupByBucket(Map, String...)}</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=cm>   */</span>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=w>  </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getBucketNameToCount</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>fieldName</span><span class=p>);</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=p>}</span>
</code></pre></div> <p>Using the proposed API to achieve the <code>Facet Counting on Multiple Columns</code> use case above would look like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>VIP5Example</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>vip</span><span class=p>(</span><span class=n>AvroGenericReadComputeStoreClient</span><span class=o>&lt;</span><span class=n>GenericRecord</span><span class=p>,</span><span class=w> </span><span class=n>GenericRecord</span><span class=o>&gt;</span><span class=w> </span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>GenericRecord</span><span class=o>&gt;</span><span class=w> </span><span class=n>keySet</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=c1>// Note that the computeAggregation() API is not added in this PR, and will be added once initial support is built</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>     </span><span class=n>ComputeAggregationRequestBuilder</span><span class=o>&lt;</span><span class=n>GenericRecord</span><span class=o>&gt;</span><span class=w> </span><span class=n>requestBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=na>computeAggregation</span><span class=p>();</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>    </span><span class=c1>// Using the Predicate API to define the filtering criteria of each bucket</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>currentTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Predicate</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>bucketByTimeRanges</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>    </span><span class=n>bucketByTimeRanges</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&quot;last_24h&quot;</span><span class=p>,</span><span class=w> </span><span class=n>LongPredicate</span><span class=p>.</span><span class=na>greaterThan</span><span class=p>(</span><span class=n>currentTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>MS_PER_DAY</span><span class=p>));</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>    </span><span class=n>bucketByTimeRanges</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&quot;last_week&quot;</span><span class=p>,</span><span class=w> </span><span class=n>LongPredicate</span><span class=p>.</span><span class=na>greaterThan</span><span class=p>(</span><span class=n>currentTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>7</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>MS_PER_DAY</span><span class=p>));</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>    </span><span class=n>bucketByTimeRanges</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&quot;last_30_days&quot;</span><span class=p>,</span><span class=w> </span><span class=n>LongPredicate</span><span class=p>.</span><span class=na>greaterThan</span><span class=p>(</span><span class=n>currentTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>MS_PER_DAY</span><span class=p>));</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>    </span><span class=c1>// Facet count for multiple columns, including both grouped by value and grouped by buckets</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>     </span><span class=n>ComputeAggregationRequestBuilder</span><span class=o>&lt;</span><span class=n>GenericRecord</span><span class=o>&gt;</span><span class=w> </span><span class=n>requestBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestBuilder</span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>            </span><span class=p>.</span><span class=na>countGroupByValue</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=s>&quot;clusterName&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;storeName&quot;</span><span class=p>)</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>            </span><span class=p>.</span><span class=na>countGroupByBucket</span><span class=p>(</span><span class=n>bucketByTimeRanges</span><span class=p>,</span><span class=w> </span><span class=s>&quot;reportTimestamp&quot;</span><span class=p>);</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>    </span><span class=c1>// Specify filter to specific keys in order to execute the query</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>    </span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>ComputeAggregationResponse</span><span class=o>&gt;</span><span class=w> </span><span class=n>facetCountResponse</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestBuilder</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>keySet</span><span class=p>);</span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>  </span><span class=p>}</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=p>}</span>
</code></pre></div> <p>As we can see, the proposed DSL is significantly more succinct than the equivalent SQL. That is because although SQL can be made to do nearly anything, Facet Counting of multiple columns in a single query is not a common use case.</p> <h2 id=proposed-design>Proposed Design<a class=headerlink href=#proposed-design title="Permanent link">&para;</a></h2> <p>The client-side computation is very similar to Read Compute and therefore fairly straightforward. Essentially, the client would retrieve the values for the keys of interest via Batch Get, then perform the computation locally.</p> <p>Regarding server-side computation, it could be achieved either by extending the current <code>/compute</code> endpoint on servers, or as a new endpoint. Given that there are significant differences between the two, it may be tedious to cram the two of them into the same endpoint. Moreover, since there is no need for the time being to combine Read Compute and Facet Counting for the same set of keys as part of a single query, there is no incentive for now to incur this complexity cost. If, in the future, it becomes necessary to combine these types of queries together, then the architecture can be further evolved at that point.</p> <p>The Facet Counting endpoint would need to have its own wire protocol, similar to the Read Compute wire protocol:</p> <ol> <li>Start by listing the computation details (encoded from what was specified in <code>ComputeAggregationRequestBuilder</code>).</li> <li>Then list all the keys to query and compute on.</li> </ol> <p>It is necessary to support protocol evolution, but being separate from Read Compute, these two can evolve on separate tracks.</p> <h2 id=development-milestones>Development Milestones<a class=headerlink href=#development-milestones title="Permanent link">&para;</a></h2> <ol> <li>Start with client-side support, so that users can start using the API as soon as possible, and that it works regardless of store and server settings.</li> <li>Then implement the wire protocol and server-side support.</li> </ol> <h3 id=future-work>Future Work<a class=headerlink href=#future-work title="Permanent link">&para;</a></h3> <p>Although this is out of scope from the current proposal, it is interesting to note that having the scaffolding in place to perform aggregation queries opens up the door to performing other kinds of aggregations besides counting, e.g., min, max, average, sum, or other functions...</p> <h2 id=test-plan>Test Plan<a class=headerlink href=#test-plan title="Permanent link">&para;</a></h2> <p>This functionality requires the full scope of test methodologies: unit and integration tests, followed by collaboration with early adopter users to integrate and gradually ramp.</p> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h2> <ol> <li><a href=https://lucene.apache.org/core/4_1_0/facet/org/apache/lucene/facet/doc-files/userguide.html#facet_features>Facet Counting in Lucene</a></li> </ol> <h2 id=appendix>Appendix<a class=headerlink href=#appendix title="Permanent link">&para;</a></h2> <p>See the code attached to <a href=https://github.com/linkedin/venice/pull/1612>PR 1612</a>.</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="December 24, 2025 19:25:03 UTC">December 24, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="December 24, 2025 19:25:03 UTC">December 24, 2025</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../vip-4/ class="md-footer__link md-footer__link--prev" aria-label="Previous: VIP-4"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> VIP-4 </div> </div> </a> <a href=../vip-6/ class="md-footer__link md-footer__link--next" aria-label="Next: VIP-6"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> VIP-6 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 - <script>document.write(new Date().getFullYear())</script> LinkedIn Corporation </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/linkedin/venice target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=http://slack.venicedb.org target=_blank rel=noopener title=slack.venicedb.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M94.1 315.1c0 25.9-21.2 47.1-47.1 47.1S0 341 0 315.1 21.2 268 47.1 268h47.1v47.1zm23.7 0c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1v117.8c0 25.9-21.2 47.1-47.1 47.1s-47.1-21.2-47.1-47.1zm47.1-189c-25.9 0-47.1-21.2-47.1-47.1s21.2-47 47.1-47S212 53.2 212 79.1v47.1h-47.1zm0 23.7c25.9 0 47.1 21.2 47.1 47.1S190.8 244 164.9 244H47.1C21.2 244 0 222.8 0 196.9s21.2-47.1 47.1-47.1zm189 47.1c0-25.9 21.2-47.1 47.1-47.1s47 21.2 47 47.1-21.2 47.1-47.1 47.1h-47.1v-47.1zm-23.7 0c0 25.9-21.2 47.1-47.1 47.1S236 222.8 236 196.9V79.1c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1zm-47.1 189c25.9 0 47.1 21.2 47.1 47.1s-21.2 47-47.1 47-47.1-21.2-47.1-47.1v-47.1h47.1zm0-23.7c-25.9 0-47.1-21.2-47.1-47.1s21.2-47.1 47.1-47.1h117.8c25.9 0 47.1 21.2 47.1 47.1s-21.2 47.1-47.1 47.1z"/></svg> </a> <a href=https://www.linkedin.com/company/venicedb/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://x.com/VeniceDataBase target=_blank rel=noopener title=x.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"/></svg> </a> <a href=https://youtube.com/@venicedb target=_blank rel=noopener title=youtube.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M549.7 124.1c-6.2-23.7-24.8-42.3-48.3-48.6C458.9 64 288.1 64 288.1 64S117.3 64 74.7 75.5c-23.5 6.3-42 24.9-48.3 48.6C15 167 15 256.4 15 256.4s0 89.4 11.4 132.3c6.3 23.6 24.8 41.5 48.3 47.8C117.3 448 288.1 448 288.1 448s170.8 0 213.4-11.5c23.5-6.3 42-24.2 48.3-47.8 11.4-42.9 11.4-132.3 11.4-132.3s0-89.4-11.4-132.3zM232.2 337.6V175.2l142.7 81.2z"/></svg> </a> <a href=https://blog.venicedb.org target=_blank rel=noopener title=blog.venicedb.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64m0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0m32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.path", "navigation.indexes", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "content.code.copy", "content.action.edit", "toc.follow"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../../assets/js/extra.js></script> </body> </html>