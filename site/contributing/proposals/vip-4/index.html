<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Derived Data Platform for Planet-Scale Workloads"><meta name=author content="Venice Team"><link href=https://venicedb.org/contributing/proposals/vip-4/ rel=canonical><link href=../vip-3/ rel=prev><link href=../vip-5/ rel=next><link rel=icon href=../../../assets/style/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>VIP-4 - Venice</title><link rel=stylesheet href=../../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/style/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=white> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#vip-4-store-lifecycle-hooks class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=Venice class="md-header__button md-logo" aria-label=Venice data-md-component=logo> <img src=../../../assets/style/venice_full_lion_logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Venice </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> VIP-4 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=white aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=black aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/linkedin/venice title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> linkedin/venice </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../../user-guide/ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../../operations/ class=md-tabs__link> Operations </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> Contributing </a> </li> <li class=md-tabs__item> <a href=../../../resources/learn-more/ class=md-tabs__link> Resources </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=Venice class="md-nav__button md-logo" aria-label=Venice data-md-component=logo> <img src=../../../assets/style/venice_full_lion_logo.svg alt=logo> </a> Venice </label> <div class=md-nav__source> <a href=https://github.com/linkedin/venice title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> linkedin/venice </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <div class="md-nav__link md-nav__container"> <a href=../../../getting-started/ class="md-nav__link "> <span class=md-ellipsis> Getting Started </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../getting-started/quickstart-single-dc/ class=md-nav__link> <span class=md-ellipsis> Single Datacenter </span> </a> </li> <li class=md-nav__item> <a href=../../../getting-started/quickstart-multi-dc/ class=md-nav__link> <span class=md-ellipsis> Multi Datacenter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/ class="md-nav__link "> <span class=md-ellipsis> User Guide </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/concepts/overview/ class=md-nav__link> <span class=md-ellipsis> Venice Concepts </span> </a> </li> <li class=md-nav__item> <a href=../../../user-guide/concepts/ttl/ class=md-nav__link> <span class=md-ellipsis> Time to Live (TTL) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/write-apis/ class="md-nav__link "> <span class=md-ellipsis> Write APIs </span> </a> <label class="md-nav__link " for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Write APIs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/write-apis/batch-push/ class=md-nav__link> <span class=md-ellipsis> Batch Push </span> </a> </li> <li class=md-nav__item> <a href=../../../user-guide/write-apis/stream-processor/ class=md-nav__link> <span class=md-ellipsis> Stream Processor </span> </a> </li> <li class=md-nav__item> <a href=../../../user-guide/write-apis/online-producer/ class=md-nav__link> <span class=md-ellipsis> Online Producer </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/read-apis/ class="md-nav__link "> <span class=md-ellipsis> Read APIs </span> </a> <label class="md-nav__link " for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Read APIs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/read-apis/da-vinci-client/ class=md-nav__link> <span class=md-ellipsis> Da Vinci Client </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <div class="md-nav__link md-nav__container"> <a href=../../../user-guide/design-patterns/ class="md-nav__link "> <span class=md-ellipsis> Design Patterns </span> </a> <label class="md-nav__link " for=__nav_3_5 id=__nav_3_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Design Patterns </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../user-guide/design-patterns/merging-batch-and-rt/ class=md-nav__link> <span class=md-ellipsis> Merging Batch & RT </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../../operations/ class="md-nav__link "> <span class=md-ellipsis> Operations </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Operations </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> Data Management </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Data Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/data-management/repush/ class=md-nav__link> <span class=md-ellipsis> Repush </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/data-management/system-stores/ class=md-nav__link> <span class=md-ellipsis> System Stores </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> Advanced </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../operations/advanced/p2p-bootstrapping/ class=md-nav__link> <span class=md-ellipsis> P2P Bootstrapping </span> </a> </li> <li class=md-nav__item> <a href=../../../operations/advanced/data-integrity/ class=md-nav__link> <span class=md-ellipsis> Data Integrity </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> Contributing </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Contributing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../code-of-conduct/ class=md-nav__link> <span class=md-ellipsis> Code of Conduct </span> </a> </li> <li class=md-nav__item> <a href=../../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing Guide </span> </a> </li> <li class=md-nav__item> <a href=../../security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5 id=__nav_5_5_label tabindex> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../development/workspace-setup/ class=md-nav__link> <span class=md-ellipsis> Workspace Setup </span> </a> </li> <li class=md-nav__item> <a href=../../development/dev-workflow/ class=md-nav__link> <span class=md-ellipsis> Dev Workflow </span> </a> </li> <li class=md-nav__item> <a href=../../development/testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../../development/style-guide/ class=md-nav__link> <span class=md-ellipsis> Style Guide </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_6> <label class=md-nav__link for=__nav_5_6 id=__nav_5_6_label tabindex> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/navigation/ class=md-nav__link> <span class=md-ellipsis> Project Navigation </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/write-path/ class=md-nav__link> <span class=md-ellipsis> Write Path </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/java-internals/ class=md-nav__link> <span class=md-ellipsis> Java Internals </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/router-api/ class=md-nav__link> <span class=md-ellipsis> Router API </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_7> <label class=md-nav__link for=__nav_5_7 id=__nav_5_7_label tabindex> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_7_label aria-expanded=false> <label class=md-nav__title for=__nav_5_7> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../documentation/writing-docs/ class=md-nav__link> <span class=md-ellipsis> Writing Docs </span> </a> </li> <li class=md-nav__item> <a href=../../documentation/design-docs/ class=md-nav__link> <span class=md-ellipsis> Design Docs </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> Proposals </span> </a> <label class="md-nav__link " for=__nav_5_8 id=__nav_5_8_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=true> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> Proposals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../vip-template/ class=md-nav__link> <span class=md-ellipsis> VIP Template </span> </a> </li> <li class=md-nav__item> <a href=../vip-1/ class=md-nav__link> <span class=md-ellipsis> VIP-1 </span> </a> </li> <li class=md-nav__item> <a href=../vip-2/ class=md-nav__link> <span class=md-ellipsis> VIP-2 </span> </a> </li> <li class=md-nav__item> <a href=../vip-3/ class=md-nav__link> <span class=md-ellipsis> VIP-3 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> VIP-4 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> VIP-4 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#problem-statement class=md-nav__link> <span class=md-ellipsis> Problem Statement </span> </a> </li> <li class=md-nav__item> <a href=#scope class=md-nav__link> <span class=md-ellipsis> Scope </span> </a> </li> <li class=md-nav__item> <a href=#project-justification class=md-nav__link> <span class=md-ellipsis> Project Justification </span> </a> </li> <li class=md-nav__item> <a href=#functional-specification class=md-nav__link> <span class=md-ellipsis> Functional specification </span> </a> </li> <li class=md-nav__item> <a href=#proposed-design class=md-nav__link> <span class=md-ellipsis> Proposed Design </span> </a> <nav class=md-nav aria-label="Proposed Design"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rollback-support class=md-nav__link> <span class=md-ellipsis> Rollback Support </span> </a> </li> <li class=md-nav__item> <a href=#configs class=md-nav__link> <span class=md-ellipsis> Configs </span> </a> </li> <li class=md-nav__item> <a href=#metrics class=md-nav__link> <span class=md-ellipsis> Metrics </span> </a> </li> <li class=md-nav__item> <a href=#design-recommendation class=md-nav__link> <span class=md-ellipsis> Design Recommendation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#development-milestones class=md-nav__link> <span class=md-ellipsis> Development Milestones </span> </a> </li> <li class=md-nav__item> <a href=#test-plan class=md-nav__link> <span class=md-ellipsis> Test Plan </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../vip-5/ class=md-nav__link> <span class=md-ellipsis> VIP-5 </span> </a> </li> <li class=md-nav__item> <a href=../vip-6/ class=md-nav__link> <span class=md-ellipsis> VIP-6 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Resources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../resources/learn-more/ class=md-nav__link> <span class=md-ellipsis> Learn More </span> </a> </li> <li class=md-nav__item> <a href=../../../resources/api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> </a> </li> <li class=md-nav__item> <a href=../../../resources/community/ class=md-nav__link> <span class=md-ellipsis> Community </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#problem-statement class=md-nav__link> <span class=md-ellipsis> Problem Statement </span> </a> </li> <li class=md-nav__item> <a href=#scope class=md-nav__link> <span class=md-ellipsis> Scope </span> </a> </li> <li class=md-nav__item> <a href=#project-justification class=md-nav__link> <span class=md-ellipsis> Project Justification </span> </a> </li> <li class=md-nav__item> <a href=#functional-specification class=md-nav__link> <span class=md-ellipsis> Functional specification </span> </a> </li> <li class=md-nav__item> <a href=#proposed-design class=md-nav__link> <span class=md-ellipsis> Proposed Design </span> </a> <nav class=md-nav aria-label="Proposed Design"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rollback-support class=md-nav__link> <span class=md-ellipsis> Rollback Support </span> </a> </li> <li class=md-nav__item> <a href=#configs class=md-nav__link> <span class=md-ellipsis> Configs </span> </a> </li> <li class=md-nav__item> <a href=#metrics class=md-nav__link> <span class=md-ellipsis> Metrics </span> </a> </li> <li class=md-nav__item> <a href=#design-recommendation class=md-nav__link> <span class=md-ellipsis> Design Recommendation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#development-milestones class=md-nav__link> <span class=md-ellipsis> Development Milestones </span> </a> </li> <li class=md-nav__item> <a href=#test-plan class=md-nav__link> <span class=md-ellipsis> Test Plan </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../../.. class=md-path__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-path__item> <a href=../../ class=md-path__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-path__item> <a href=../ class=md-path__link> <span class=md-ellipsis> Proposals </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <a href=https://github.com/linkedin/venice/edit/main/docs/contributing/proposals/vip-4.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <h1 id=vip-4-store-lifecycle-hooks>VIP-4: Store Lifecycle Hooks<a class=headerlink href=#vip-4-store-lifecycle-hooks title="Permanent link">&para;</a></h1> <ul> <li><strong>Status</strong>: <em>Accepted</em></li> <li><strong>Author(s)</strong>: <em>Felix GV</em></li> <li><strong>Pull Request</strong>: <a href=https://github.com/linkedin/venice/pull/881>PR 881</a></li> <li><strong>Release</strong>: <em>N/A</em></li> </ul> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>The <a href=../../../user-guide/write-apis/batch-push/ >Venice Push Job</a> takes data from a grid and pushes it to a store in all regions. This works fine in many cases, but there are some use cases where we would like to have greater control over the steps of the process. This proposal is to add new configs and hooks which can be used both to monitor and control the push job in a finer-grained manner than is possible today. In particular, this proposal focuses on the way that each individual region is handled.</p> <p>Currently, the sequence of steps happening within a push job is as follows:</p> <p><img alt="Push Job Steps" src=../../../assets/images/push_job_steps.drawio.svg></p> <p>A few notes on the above diagram:</p> <ul> <li> <p>A new schema will be registered only if the data being pushed does not conform to any already known schema, and the schema auto-registration config is enabled. If that config is disabled, then an unknown schema leads to job failure.</p> </li> <li> <p>The compression job is optional, and whether it runs or not depends on configurations.</p> </li> <li> <p>The data push job writes to a store-version pub sub topic in one of the regions (typically the one which is local to where the push job is running), but all regions start ingesting right away, as soon as the data push job begins writing. For regions that are remote from the topic the data push job is writing to, the leader servers are performing replication, while in the region which contains that topic, the replication is a no-op.</p> </li> <li> <p>The <code>SERVING</code> step is also called "version swap". If there are Da Vinci Clients, they will ingest and swap on their own, and the child controller of that region will wait until all DVC instances have swapped (started serving) before enacting the region-level swap, after which the servers will also start serving the new store-version to clients which perform remote queries. That is why the "DVC Read Traffic SERVING" step is a dependency for the "Server Read Traffic SERVING" step.</p> </li> </ul> <h2 id=problem-statement>Problem Statement<a class=headerlink href=#problem-statement title="Permanent link">&para;</a></h2> <p>Pushing to all regions in parallel makes the push faster, but it also means that if the push causes an issue, the impact is going to be global (affecting all regions). It would be desirable to have certain checks and balances that reduce the blast radius in cases where the content of the push causes issues. Examples of such issues include:</p> <ul> <li>Data quality issues:</li> <li>Incomplete data (due to issues in data generation logic, or in upstream datasets).</li> <li>Change in semantics (e.g. some embeddings trained by a new ML model / weights / params / etc. are incompatible with that used at inference-time).</li> <li>Schema-related issues:</li> <li>Some optional fields which used to always be populated get deleted (or get populated with null) and the reading app fails due to lack of null checking. This kind of app-side bug can happen even though a schema evolution is fully compatible.</li> <li>Infra issues:</li> <li>Larger payloads take more resources, resulting in lack of capacity and thus latency degradation.</li> <li>Certain types of yet-unknown infra bugs are somehow triggered by a data push.</li> </ul> <p>Tighter control of how the new version of the dataset is deployed to each region could allow us to catch issues while only one region is affected, and abort deploying to other regions. See Scope, below, for specific examples of flow control strategies.</p> <p>In addition, we would like to make it easier to integrate the push job into proprietary monitoring systems such that each region getting data deployed to it results in events getting emitted or other observability actions.</p> <h2 id=scope>Scope<a class=headerlink href=#scope title="Permanent link">&para;</a></h2> <p>This proposal is about full push jobs. Incremental pushes and nearline writes are out of scope. At the time of submitting this proposal, it is undetermined whether this work will apply to stream reprocessing jobs. In terms of priority, we care mostly about supporting full pushes from offline grids, and it may be fine to leave stream reprocessing out of scope, although depending on the design details we choose, we may be able to support stream reprocessing "for free" as well (i.e. if the hooks are executed in the controller). Incremental Push is out of scope of this proposal.</p> <p>The goal is for lifecycle hooks to achieve the following use cases:</p> <ul> <li>Orchestrate how data is served in each region, including:</li> <li>Ensuring a minimum delay (e.g. 1 hour) between each region beginning to serve the new store-version.</li> <li>Delaying the swapping of a new store-version to be within some time of day (e.g. during "business hours").</li> <li>Performing custom health checks on the client applications to ensure that their key metrics are still healthy within a region where a new store-version was swapped, before proceeding to more regions. Based on the outcome of this check:<ul> <li>Having the ability to abort the swapping of a store-version to further regions.</li> <li>Having the ability to rollback to the previous store-version in regions that already swapped.</li> </ul> </li> <li>Trigger informational events in proprietary monitoring systems after important lifecycle milestones are completed.</li> </ul> <p>The above use cases all are operator-centric, and so (at least for now) there is no concern of making it very ergonomic for Venice users to register new hooks or evolve old hooks dynamically. The general expectation is that there would be a small number of hooks maintained by the Venice operators and that it's ok for hooks to be bundled and upgraded alongside the Venice components. In cases where Venice users need to customize hook behaviors, that could be achieved via store-level configs passed into hooks, and there is no need to provide the flexibility of letting users register whole new hook implementations.</p> <h2 id=project-justification>Project Justification<a class=headerlink href=#project-justification title="Permanent link">&para;</a></h2> <p>The cost of having global impact in the case of issues mentioned above is too high, and we would like to provide first-class options to reduce the blast radius. Building this within Venice itself will make it easier to automate these methodologies, thus reducing toil for users.</p> <h2 id=functional-specification>Functional specification<a class=headerlink href=#functional-specification title="Permanent link">&para;</a></h2> <p>The proposed API for this functionality is described in code here:</p> <ul> <li><a href=/venice/javadoc/com/linkedin/venice/hooks/StoreLifecycleHooks.html>StoreLifecycleHooks</a>, which is the main part of this proposal.</li> <li><a href=/venice/javadoc/com/linkedin/venice/hooks/StoreLifecycleEventOutcome.html>StoreLifecycleEventOutcome</a>, which is the signal returned by some hooks to indicate that a given step should proceed or abort.</li> <li><a href=/venice/javadoc/com/linkedin/venice/hooks/StoreVersionLifecycleEventOutcome.html>StoreVersionLifecycleEventOutcome</a>, which is the signal returned by some other hooks which need more fine-grained control over the workflow. In addition to proceeding and aborting, this also provides the option to wait, which tells the hooks framework to try invoking the hook again later, and rollback, which tells the framework to rollback to the previous store-version in all regions.</li> <li><a href=/venice/javadoc/com/linkedin/venice/controllerapi/JobStatusQueryResponse.html>JobStatusQueryResponse</a>, which is the payload returned by the <code>/job</code> controller endpoint, is extended to include status update timestamps. This will be populated by the child controller to indicate the time when its own individual status last changed, and the parent controller will aggregate these into a map keyed by region. All hooks which return the <code>StoreVersionLifecycleEventOutcome</code> will have access to this payload in their input, so that they can make decisions based on the status of each region. The time when the status was last updated for a given region is useful in order to achieve the use case of a hook which injects a delay between each region swap. The code change to support these extra timestamps is included in this VIP, to demonstrate feasibility and present the proposed algorithm (see <code>OfflinePushStatus::getStatusUpdateTimestamp</code>).</li> </ul> <h2 id=proposed-design>Proposed Design<a class=headerlink href=#proposed-design title="Permanent link">&para;</a></h2> <p>The main design consideration is where to execute the hooks. At a high level, there are three options:</p> <ol> <li>Within the push job.</li> <li>Within the parent controller (chosen option).</li> <li>Within the child controllers.</li> </ol> <p>It is also possible to consider invoking some hooks in one of these location while other hooks would be executed elsewhere. The table below summarizes the feasibility and tradeoffs for each of the proposed hooks:</p> <table> <thead> <tr> <th style="text-align: right;">Hook function name</th> <th style="text-align: center;">Actions</th> <th style="text-align: center;">CC</th> <th style="text-align: center;">PC</th> <th style="text-align: center;">VPJ</th> </tr> </thead> <tbody> <tr> <td style="text-align: right;"><code>validateHookConfig</code></td> <td style="text-align: center;">➡️ ☠️</td> <td style="text-align: center;">❌</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">❌</td> </tr> <tr> <td style="text-align: right;"><code>preStartOfPushJob</code></td> <td style="text-align: center;">➡️ ☠️</td> <td style="text-align: center;">❌</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: right;"><code>postStartOfPushJob</code></td> <td style="text-align: center;">None</td> <td style="text-align: center;">❌</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: right;"><code>preSchemaRegistration</code></td> <td style="text-align: center;">➡️ ☠️</td> <td style="text-align: center;">❌</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">1️⃣</td> </tr> <tr> <td style="text-align: right;"><code>postSchemaRegistration</code></td> <td style="text-align: center;">None</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">1️⃣</td> </tr> <tr> <td style="text-align: right;"><code>preStoreVersionCreation</code></td> <td style="text-align: center;">➡️ ☠️ ✋ ↩️</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: right;"><code>postStoreVersionCreation</code></td> <td style="text-align: center;">None</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: right;"><code>preStartOfStoreVersionIngestionForDaVinci</code></td> <td style="text-align: center;">➡️ ☠️ ✋ ↩️</td> <td style="text-align: center;">2️⃣</td> <td style="text-align: center;">2️⃣</td> <td style="text-align: center;">2️⃣</td> </tr> <tr> <td style="text-align: right;"><code>postStartOfStoreVersionIngestionForDaVinci</code></td> <td style="text-align: center;">➡️ ☠️ ✋ ↩️</td> <td style="text-align: center;">2️⃣</td> <td style="text-align: center;">2️⃣</td> <td style="text-align: center;">2️⃣</td> </tr> <tr> <td style="text-align: right;"><code>postStoreVersionLeaderReplication</code></td> <td style="text-align: center;">None</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">❌</td> <td style="text-align: center;">❌</td> </tr> <tr> <td style="text-align: right;"><code>preStoreVersionSwap</code></td> <td style="text-align: center;">➡️ ☠️ ✋ ↩️</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: right;"><code>postStoreVersionSwap</code></td> <td style="text-align: center;">➡️ ☠️ ✋ ↩️</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: right;"><code>preEndOfPushJob</code></td> <td style="text-align: center;">➡️ ☠️ ✋ ↩️</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> <tr> <td style="text-align: right;"><code>postEndOfPushJob</code></td> <td style="text-align: center;">None</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> <td style="text-align: center;">✅</td> </tr> </tbody> </table> <p><strong>Legend:</strong></p> <ul> <li>The Actions column represent which control mechanism is available to each hook:</li> <li>➡️ Proceed: Move forward with this step.</li> <li>☠️ Abort: Cancel this step (and as a consequence, short-circuit any future step that would come after this one).</li> <li>✋ Wait: Let the hooks framework re-run this step later (i.e. 1 minute later, by default).</li> <li> <p>↩️ Rollback: Let the store go back to the store-version it had prior to beginning the push job (in all regions). </p> </li> <li> <p>The last three columns are the feasibility of implementing this hook in a given component:</p> </li> <li><strong>CC</strong> Child Controller.</li> <li><strong>PC</strong> Parent Controller.</li> <li><strong>VPJ</strong> Venice Push Job.</li> <li>✅ It is feasible to implement this hook within this component (without unreasonable complexity).</li> <li>❌ It is NOT feasible to implement this hook within this component (without unreasonable complexity).</li> <li>1️⃣ Schema registration hooks in push jobs could only be invoked in cases where auto-registration is enabled and the new schema originates from the push job itself, whereas schema registrations which are performed directly on the controller could not trigger the hook.</li> <li>2️⃣ The hook for the start of ingestion for Da Vinci Clients is tricky for a few reasons. The start of ingestion is controlled by updating the Meta Store, which is a non-replicated system store updated by child controllers, so those must be involved (either by running the hook there in the first place, or by having some mechanism that enables the parent or VPJ to inform the child controllers of when the system store is eligible for getting updated, such as by adding a new field to the <code>AddVersion</code> admin channel command). However, see Rollback Support below for why running hooks in the child controller may be insufficient.</li> </ul> <h3 id=rollback-support>Rollback Support<a class=headerlink href=#rollback-support title="Permanent link">&para;</a></h3> <p>In order to support the ability for the hooks which return the <code>StoreVersionLifecycleEventOutcome</code> to rollback, the most natural way to achieve this is likely to involve the parent controller, either by having those hooks run there in the first place, or by having a propagation mechanism to it:</p> <ul> <li> <p>If the hooks are executed in the child controller, the propagation mechanism might be to extend the job status check which the parent controller does periodically in order for the child to inform the parent of the need to rollback, or else build a new mechanism for the child to directly interact with the parent (or even with other child controllers directly...).</p> </li> <li> <p>If the hooks are executed in VPJ, then it would need to interact with the parent via the controller client to trigger the rollback.</p> </li> </ul> <h3 id=configs>Configs<a class=headerlink href=#configs title="Permanent link">&para;</a></h3> <p>There needs to be new configs:</p> <ul> <li> <p><code>venice.store.lifecycle.hooks</code>: Comma-separated list of FQCN of the hook implementations to load.</p> </li> <li> <p><code>venice.store.lifecycle.hooks.threads</code>: Number of threads used by the hooks framework to execute all hooks.</p> </li> <li> <p><code>venice.store.lifecycle.hooks.timeout.seconds</code>: Max duration allowed for a hook before the hooks framework interrupts it.</p> </li> <li> <p><code>venice.store.lifecycle.hooks.wait.interval.seconds</code>: The time to wait before re-invoking a hook which returned <code>WAIT</code> (default: 60 seconds).</p> </li> <li> <p><code>venice.store.lifecycle.hooks.configs.&lt;arbitrary&gt;</code>: Any number of configs to be passed (after clipping everything before the <code>&lt;arbitrary&gt;</code> part) into the hooks constructor.</p> </li> </ul> <p>In addition, the store config will get a new <code>Map&lt;String, String&gt;</code> of store-level config overrides. Those configs are "<a href=https://wiki.c2.com/?StringlyTyped>stringly-typed</a>", rather than strongly-typed, since we are not aware of the configs needed by each hook at compile-time, and we therefore cannot shape the definition of the store config schema accordingly. This issue is mitigated via the <code>validateHookConfig</code>, which can be used to prevent invalid configs from entering the system.</p> <h3 id=metrics>Metrics<a class=headerlink href=#metrics title="Permanent link">&para;</a></h3> <p>There needs to be new metrics to monitor hook health. Each new metric will be per function and per registered hooks class (i.e. 13 functions per class if we implement all of them, or less if we cut the scope). For each class/function hook, there will be:</p> <ul> <li>the occurrence rate of:</li> <li>hook invocations</li> <li>each hook return signal (for the functions that return something other than <code>void</code>)</li> <li>failures (exceptions)</li> <li>timeouts</li> <li>the time spend waiting in queue before being executed (which will be useful to determine if the thread pool count is under-provisioned)</li> </ul> <p>N.B.: Implementing metrics from within VPJ is a bit more complicated, whereas controllers already have the ability to emit metrics.</p> <h3 id=design-recommendation>Design Recommendation<a class=headerlink href=#design-recommendation title="Permanent link">&para;</a></h3> <p>Running hooks in the parent controller is probably most straightforward. The only issue is the inability to support the <code>postStoreVersionLeaderReplication</code> hook, but that one is not critical and could be left out of scope.</p> <p>Concretely, choosing the parent controller path would work like this:</p> <ol> <li> <p>The parent controller would invoke the hooks for <code>preStartOfStoreVersionIngestionForDaVinci</code> and for <code>preStoreVersionCreation</code> for each of the regions. If all hooks respond with <code>PROCEED</code> then it's essentially a normal push, otherwise it would configure the <code>AddVersion</code> command sent to the admin channel with the appropriate inclusions in <code>targetedRegions</code> (depending on the result of <code>preStoreVersionCreation</code>) and in a new field for controlling the DVC ingestion (depending on the result of <code>preStartOfStoreVersionIngestionForDaVinci</code>) which the child controller would honor by holding off on writing to the Meta Store.</p> </li> <li> <p>The parent controller would create the new store-version with <code>versionSwapDeferred = true</code>.</p> </li> <li> <p>When the parent controller sees that a region has completed ingestion, it would invoke the <code>preStoreVersionSwap</code> hook for that region, and if the hook responds with <code>PROCEED</code>, then it would send an admin command targeted for that region to swap the current version.</p> </li> <li> <p>If at any stage the hooks respond with <code>ROLLBACK</code> then the parent controller would send more admin channel commands to do the swap in the reverse direction.</p> </li> </ol> <p><strong>This recommendation has been accepted, after design reviews, hence we will implement hooks in the parent controller.</strong></p> <h2 id=development-milestones>Development Milestones<a class=headerlink href=#development-milestones title="Permanent link">&para;</a></h2> <p>At a high-level:</p> <ol> <li>Evolve the admin channel protocol.</li> <li>Implement the child controller changes for dealing with the admin channel changes.</li> <li>Implement the parent controller changes to support the hooks framework and the orchestration described above.</li> </ol> <p>More fine-grained plan TBD after finalizing the design.</p> <h2 id=test-plan>Test Plan<a class=headerlink href=#test-plan title="Permanent link">&para;</a></h2> <p>The first hooks will be built such that they are no-op by default, and require a hook config to enable them. That hook config will be left disabled in the global config, and will be tested at small scale via the store-level overrides.</p> <p>After store-level testing and stabilization is satisfactory, we will begin enabling them globally.</p> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h2> <p>N/A.</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="December 24, 2025 19:25:03 UTC">December 24, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="December 24, 2025 19:25:03 UTC">December 24, 2025</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../vip-3/ class="md-footer__link md-footer__link--prev" aria-label="Previous: VIP-3"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> VIP-3 </div> </div> </a> <a href=../vip-5/ class="md-footer__link md-footer__link--next" aria-label="Next: VIP-5"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> VIP-5 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 - <script>document.write(new Date().getFullYear())</script> LinkedIn Corporation </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/linkedin/venice target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=http://slack.venicedb.org target=_blank rel=noopener title=slack.venicedb.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M94.1 315.1c0 25.9-21.2 47.1-47.1 47.1S0 341 0 315.1 21.2 268 47.1 268h47.1v47.1zm23.7 0c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1v117.8c0 25.9-21.2 47.1-47.1 47.1s-47.1-21.2-47.1-47.1zm47.1-189c-25.9 0-47.1-21.2-47.1-47.1s21.2-47 47.1-47S212 53.2 212 79.1v47.1h-47.1zm0 23.7c25.9 0 47.1 21.2 47.1 47.1S190.8 244 164.9 244H47.1C21.2 244 0 222.8 0 196.9s21.2-47.1 47.1-47.1zm189 47.1c0-25.9 21.2-47.1 47.1-47.1s47 21.2 47 47.1-21.2 47.1-47.1 47.1h-47.1v-47.1zm-23.7 0c0 25.9-21.2 47.1-47.1 47.1S236 222.8 236 196.9V79.1c0-25.9 21.2-47.1 47.1-47.1s47.1 21.2 47.1 47.1zm-47.1 189c25.9 0 47.1 21.2 47.1 47.1s-21.2 47-47.1 47-47.1-21.2-47.1-47.1v-47.1h47.1zm0-23.7c-25.9 0-47.1-21.2-47.1-47.1s21.2-47.1 47.1-47.1h117.8c25.9 0 47.1 21.2 47.1 47.1s-21.2 47.1-47.1 47.1z"/></svg> </a> <a href=https://www.linkedin.com/company/venicedb/ target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://x.com/VeniceDataBase target=_blank rel=noopener title=x.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"/></svg> </a> <a href=https://youtube.com/@venicedb target=_blank rel=noopener title=youtube.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M549.7 124.1c-6.2-23.7-24.8-42.3-48.3-48.6C458.9 64 288.1 64 288.1 64S117.3 64 74.7 75.5c-23.5 6.3-42 24.9-48.3 48.6C15 167 15 256.4 15 256.4s0 89.4 11.4 132.3c6.3 23.6 24.8 41.5 48.3 47.8C117.3 448 288.1 448 288.1 448s170.8 0 213.4-11.5c23.5-6.3 42-24.2 48.3-47.8 11.4-42.9 11.4-132.3 11.4-132.3s0-89.4-11.4-132.3zM232.2 337.6V175.2l142.7 81.2z"/></svg> </a> <a href=https://blog.venicedb.org target=_blank rel=noopener title=blog.venicedb.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64m0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0m32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.path", "navigation.indexes", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "content.code.copy", "content.action.edit", "toc.follow"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../../assets/js/extra.js></script> </body> </html>